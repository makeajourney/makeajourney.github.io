---
title : "Ansible"
layout : post
---

# Ansible  

python 기반, YAML로 정의, ssh 기반,  json 방식으로 통신.  


ssh 기반 하에 기본적인 machine 관리.  
Currently Ansible can be run from any machine with Python 2.6 or 2.7 installed.  
ruby가 익숙하지 않을 때 좋은 대안.  

playbook  
ad-hoc 지원.  
병렬 provisioning 지원.  
vagrant  
jinja2  


멱등성  
  - 여러번 적용해도 결과는 바뀌지 않음. (shell, command, file module은 보장 안됨.)  



## 설치  


### centos에서 yum으로 install  

```{.bash}
sudo yum install ansible
```  

`No package ansible available.` 이라고 나오면,  

```{.bash}
sudo yum install epel-release
sudo yum repolist
```  

Ansible이 Extra Packages for Enterprise Linux (EPEL) repository의 일부이기 때문에 epel-release package를 설치해줘야 한다. 이후 다시 yum install하면 dependency와 함께 모두 잘 설치됨을 알 수 있다.  


<br/>


## inventory setting  

여러개의 target vm을 제어하기 위해서, hosts 파일을 생성해서 관리해야 한다.  
기본값으로 `/etc/ansible/hosts`에 작성하면 ansible이 알아서 인식한다.  
다른 경로나 이름의 파일을 사용하고 싶은 경우, `ansible` 혹은 `ansible-playbook` 명령을 사용할 때 `-i` 옵션을 사용하여 명시하면 된다.  

```{.bash}
ansible-playbook -i ansible_hosts example_play.yml
```  

여기서 `ansible_hosts`가 inventory 파일이다.  

inventory 파일 작성법은 [Ansible documentation  - Inventory](http://docs.ansible.com/ansible/intro_inventory.html) 를 참고하면 된다. 바로 다음에 보이는 [Dynamic Inventory](http://docs.ansible.com/ansible/intro_dynamic_inventory.html)를 참고하면 더 Advance된 사용이 가능할 것 같다.  


<br/>


## playbook  


### example  


1. 파일 생성  

```{.yaml}
---
- hosts: targets
  become: yes
  user: centos
  vars:
    motd_warning: 'WARNING: Use by ACME Employees ONLY'
  tasks:
    - name: setup a MOTD
      copy: dest=/etc/motd content={{ motd_warning }}
```  

* hosts : target hosts name (여기서는 group name)  
* become : sudo 권한으로 target을 제어하기 위해 사용.  
* user : target host의 username.  
* vars : 필요한 변수 선언해서 사용 가능하다. 이렇게 선언한 변수들은 `{{ 변수이름 }}` 형식으로 사용할 수 있다.  
* tasks : 수행할 작업들.  


결과  

```{.bash}
PLAY [targets] *****************************************************************

TASK [setup] *******************************************************************
ok: [10.0.4.241]
ok: [10.0.4.239]

TASK [setup a MOTD] ************************************************************
changed: [10.0.4.241]
changed: [10.0.4.239]

PLAY RECAP *********************************************************************
10.0.4.239                 : ok=2    changed=1    unreachable=0    failed=0   
10.0.4.241                 : ok=2    changed=1    unreachable=0    failed=0  
```  


#### Variables (변수 사용)  


위의 예제에서 vars에 변수를 쓰는 대신, 별도의 파일로 분리해서 가져올 수도 있는데, 이 때는 `vars_files :` 라고 작성하며, 아래에 파일 경로와 파일명을 작성한다. 변수 파일은 아래 형식으로 작성되면 된다.  

```{.yaml}
---
ntp: 'ntp1.au.example.com'
TZ: 'Austrailia/Sydney'
```  

대화형 프롬프트를 사용할 수도 있다.  

```{.yaml}
vars_prompt:
  - name: 'https_passphrase'
    prompt: 'Key Passphrase'
    private: yes
```  


환경설정 파일 및 스크립트 배포  
다운로드  
실행  








ansible  
ansible-playbook  


role
